name: MLOps CI/CD Pipeline

# Trigger the workflow on push to the 'main' branch
on:
  push:
    branches: [ "main" ]

jobs:
  # Job 1: Run the SonarCloud Code Scan
  code_scan:
    name: Code Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # We need to fetch all history for SonarCloud analysis
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          # We use the secrets we set up in GitHub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # We pass the org and project key from our secrets
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}

  # Job 2: Deploy to HuggingFace Spaces
  deploy_to_huggingface:
    name: Deploy to HuggingFace
    runs-on: ubuntu-latest
    needs: code_scan
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true # <-- This is important

      - name: Push to Hugging Face Hub
        env:
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: ${{ secrets.SPACE_NAME }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "Setting up Git LFS..."
          git lfs install
          
          echo "Pulling LFS files..."
          # --- THIS IS THE NEW, CRITICAL COMMAND ---
          # This forces git to download the *real* .pkl file
          git lfs pull
          # ----------------------------------------
          
          echo "Cloning HuggingFace Space: ${SPACE_NAME}"
          git clone "https://OAuth:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${SPACE_NAME}" "${SPACE_NAME}"
          
          echo "Syncing project files to cloned repo..."
          rsync -av --delete --exclude=".git*" --exclude=".github*" --exclude="${SPACE_NAME}" . ./${SPACE_NAME}/
          
          cd "${SPACE_NAME}"
          echo "Inside cloned repo directory."

          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          echo "Tracking .pkl files with LFS..."
          git lfs track "*.pkl"
          git add .gitattributes
          
          echo "Adding all changes..."
          git add .
          
          if ! git diff-index --quiet HEAD; then
            echo "Changes detected, committing and pushing..."
            git commit -m "Deploy from GitHub Actions (commit: ${GITHUB_SHA})"
            git push
            echo "Changes pushed to HuggingFace."
          else
            echo "No file changes detected, nothing to push."
          fi

  # Job 3: Run the Selenium Smoke Test
  smoke_test:
    name: Smoke Test
    runs-on: ubuntu-latest
    # This job depends on the 'deploy_to_huggingface' job
    needs: deploy_to_huggingface
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Google Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      
      - name: Install ChromeDriver
        run: |
          CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f 3 | cut -d '.' -f 1)
          DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
          wget -q "https://chromedriver.storage.googleapis.com/${DRIVER_VERSION}/chromedriver_linux64.zip"
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Install Selenium and other dependencies
        run: |
          pip install selenium
          pip install -r requirements.txt

      - name: Wait for HuggingFace Space to build
        run: |
          echo "Waiting 60 seconds for HuggingFace to build the new container..."
          sleep 60
          
      - name: Run Selenium Test
        env:
          APP_URL: ${{ secrets.APP_URL }}
        run: python test_app.py