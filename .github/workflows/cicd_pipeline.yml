name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  # Job 1: Run the SonarCloud Code Scan
  code_scan:
    name: Code Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}

  # Job 2: Deploy to HuggingFace Spaces
  deploy_to_huggingface:
    name: Deploy to HuggingFace
    runs-on: ubuntu-latest
    needs: code_scan
    steps:
      # Step 1: Check out your GitHub repo, including LFS files
      - uses: actions/checkout@v3
        with:
          lfs: true
          fetch-depth: 0 # Fetch all history

      # Step 2: Push this repo to your HuggingFace Space
      - name: Push to Hugging Face Hub
        env:
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: ${{ secrets.SPACE_NAME }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "Adding HuggingFace Space as a git remote..."
          # Add the HF Space as a remote named "space"
          git remote add space "https://OAuth:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${SPACE_NAME}"
          
          echo "Force-pushing main branch to HuggingFace..."
          # Force-push your local main branch to the 'main' branch on the HF Space
          # The 'main:main' part maps your local 'main' to the remote 'main'
          git push --force space main:main
          
          echo "Deployment push complete."

  # Job 3: Run the Selenium Smoke Test
  smoke_test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: deploy_to_huggingface
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Google Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      
      - name: Install ChromeDriver
        run: |
          CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f 3 | cut -d '.' -f 1)
          DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
          wget -q "https://chromedriver.storage.googleapis.com/${DRIVER_VERSION}/chromedriver_linux64.zip"
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Install Selenium and other dependencies
        run: |
          pip install selenium
          pip install -r requirements.txt

      - name: Wait for HuggingFace Space to build
        run: |
          echo "Waiting 60 seconds for HuggingFace to build the new container..."
          sleep 60
          
      - name: Run Selenium Test
        env:
          APP_URL: ${{ secrets.APP_URL }}
        run: python test_app.py